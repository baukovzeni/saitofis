{% extends 'base.html' %}
{% block content %}
<h1>–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç ‚Äî {{ date|date:"d.m.Y" }}</h1>

<div class="card glass" style="margin-bottom:16px;">
  <p style="margin:0 0 8px 0">
    <strong>–í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂:</strong> {{ sales.count }}<br>
    <strong>–°—É–º–º–∞:</strong> {{ total }} ‚ÇΩ
  </p>

  <h4 style="margin:12px 0 6px">–ü–æ —Å–ø–æ—Å–æ–±–∞–º –æ–ø–ª–∞—Ç—ã:</h4>
  <ul style="margin:0; padding-left:18px">
    {% for row in by_pm %}
      <li>{{ row.payment_method|default:"‚Äî" }} ‚Äî <b>{{ row.sum }} ‚ÇΩ</b></li>
    {% empty %}
      <li>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>
    {% endfor %}
  </ul>
</div>

<div class="card glass">
  <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px;">
    <div style="display:flex;gap:12px;align-items:center;">
      <label style="display:flex;gap:8px;align-items:center;">
        <input type="checkbox" id="checkAll">
        <span>–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</span>
      </label>
      <span id="selCount" style="opacity:.7;">0 –≤—ã–±—Ä–∞–Ω–æ</span>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞; –µ—Å–ª–∏ –ø—Ä–∞–≤ –Ω–µ—Ç ‚Äî –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞, –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—á–µ–º—É -->
    <button id="deleteSelected"
            class="btn"
            data-has-perm="{% if perms.sales.delete_sale %}1{% else %}0{% endif %}"
            title="{% if perms.sales.delete_sale %}–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏{% else %}–ù–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ (sales.delete_sale){% endif %}">
      üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
    </button>
  </div>

  <table id="salesTable">
    <thead>
      <tr>
        <th style="width:1%;"></th>
        <th>–í—Ä–µ–º—è</th>
        <th>–ü—Ä–æ–¥–∞–≤–µ—Ü</th>
        <th>–ö–ª–∏–µ–Ω—Ç</th>
        <th>–¢–æ–≤–∞—Ä—ã</th>
        <th>–°—É–º–º–∞, ‚ÇΩ</th>
        <th>–û–ø–ª–∞—Ç–∞</th>
      </tr>
    </thead>
    <tbody>
      {% for sale in sales %}
      <tr data-id="{{ sale.id }}">
        <td><input type="checkbox" class="row-check" value="{{ sale.id }}"></td>
        <td>{{ sale.created_at|date:"H:i:s" }}</td>
        <td>
          {% if sale.cashier %}
            {{ sale.cashier.get_full_name|default:sale.cashier.username }}
          {% else %}‚Äî{% endif %}
        </td>
        <td>{{ sale.customer.name|default:"‚Äî" }}</td>
        <td>
          <ul style="margin:0;padding-left:16px;">
            {% for item in sale.items.all %}
              <li>{{ item.product.name }} ‚Äî {{ item.quantity }} √ó {{ item.price }} ‚ÇΩ</li>
            {% endfor %}
          </ul>
        </td>
        <td><b>{{ sale.total }}</b></td>
        <td>{{ sale.payment_method|default:"‚Äî" }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="7" style="text-align:center;">–ü—Ä–æ–¥–∞–∂ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
/* ===== –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ ===== */
const qs = (s, r=document)=>r.querySelector(s);
const qsa = (s, r=document)=>[...r.querySelectorAll(s)];

function getCookie(name) {
  const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
  return m ? m.pop() : '';
}
const csrftoken = getCookie('csrftoken');

const table = qs('#salesTable');
const checkAll = qs('#checkAll');
const deleteBtn = qs('#deleteSelected');
const selCount = qs('#selCount');

function selectedIds(){
  return qsa('.row-check:checked', table).map(i=>i.value);
}
function updateUI(){
  const count = selectedIds().length;
  selCount.textContent = count + ' –≤—ã–±—Ä–∞–Ω–æ';
  const hasPerm = deleteBtn.dataset.hasPerm === '1';
  deleteBtn.disabled = !hasPerm || count === 0;
  deleteBtn.style.opacity = deleteBtn.disabled ? .55 : 1;
  deleteBtn.style.cursor = deleteBtn.disabled ? 'not-allowed' : 'pointer';
}

checkAll?.addEventListener('change', e=>{
  const on = e.target.checked;
  qsa('.row-check', table).forEach(ch=>{ ch.checked = on; });
  updateUI();
});

table?.addEventListener('change', (e)=>{
  if(e.target.classList.contains('row-check')){
    if(!e.target.checked) checkAll.checked = false;
    updateUI();
  }
});

deleteBtn?.addEventListener('click', async ()=>{
  const hasPerm = deleteBtn.dataset.hasPerm === '1';
  if(!hasPerm){
    alert('–ù–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂ (sales.delete_sale). –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.');
    return;
  }
  const ids = selectedIds();
  if(!ids.length) return;

  if(!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥–∞–∂–∏ (${ids.length} —à—Ç.)? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;

  try{
    const url = "{% url 'reports:sale_delete_bulk' %}";
    const res = await fetch(url, {
      method:'POST',
      headers: { 'X-CSRFToken': csrftoken, 'Content-Type':'application/json' },
      body: JSON.stringify({ ids })
    });
    const data = await res.json().catch(()=>({ok:false}));

    if(res.ok && data.ok){
      // —É–±—Ä–∞—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
      ids.forEach(id=>{
        const tr = table.querySelector(`tr[data-id="${id}"]`);
        if(tr) tr.remove();
      });
      checkAll.checked = false;
      updateUI();
    }else{
      alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ' + (data.error || res.status));
    }
  }catch(err){
    alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    console.error(err);
  }
});

// –Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
updateUI();
</script>
{% endblock %}